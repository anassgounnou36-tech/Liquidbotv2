# üì© COPILOT-PERFECT MESSAGE ‚Äî FULL VERSION

**Project:** Aave v3 Liquidation Bot ‚Äî Base (2025)

**Goal:**
Build a **production-grade, high-speed, precision liquidation bot** using TypeScript + ethers.js.
Focus: **rare liquidations, speed, correctness, capital preservation**.

Bot must be **event-driven**, **state-machine-based**, and **configurable via `.env`**.

---

## 1Ô∏è‚É£ HARD RULES (DO NOT VIOLATE)

* ‚ùå Do NOT recompute HF for all borrowers per block
* ‚ùå Do NOT poll prices per block
* ‚ùå Do NOT trust Chainlink as primary signal
* ‚ùå Do NOT broadcast to public mempool by default
* ‚ùå Do NOT execute unless all conditions are met

‚úÖ Use:

* Event-driven promotion of borrowers (SAFE ‚Üí WATCH ‚Üí CRITICAL ‚Üí LIQUIDATABLE)
* Off-chain price prediction first
* Oracle confirmation last
* Safe failure handling (skip execution on errors)

---

## 2Ô∏è‚É£ TARGET PROTOCOL

* Chain: Base
* Protocol: Aave v3
* Phase 1 assets:

  * Debt: USDC
  * Collateral: WETH, cbETH

Design must allow future expansion to other protocols/assets.

---

## 3Ô∏è‚É£ BORROWER STATE MACHINE

Each borrower must be in **exactly one state**:

```ts
enum BorrowerState {
  SAFE,
  WATCH,
  CRITICAL,
  LIQUIDATABLE
}
```

**HF thresholds (`.env` hot-reloadable):**

```env
HF_WATCH=1.10
HF_CRITICAL=1.04
HF_LIQUIDATABLE=1.000
```

**State transition rules:**

* SAFE ‚Üí WATCH ‚Üí CRITICAL ‚Üí LIQUIDATABLE
* Reverse transitions allowed if HF improves
* Execution ONLY when LIQUIDATABLE

**Promotion of low-HF users:**

* Occurs **asynchronously** via price events or borrow/repay events
* SAFE borrowers are promoted to WATCH automatically if HF drops below `HF_WATCH`
* Ensures **no low-HF borrower is missed**

---

## 4Ô∏è‚É£ HEALTH FACTOR CALCULATION

* ‚ùå Do NOT use The Graph
* ‚ùå Do NOT trust subgraph HF
* Compute HF **locally** using:

  * Cached collateral balances
  * Cached debt balances
  * Aave liquidation thresholds
  * Predicted off-chain prices

Formula:

```
HF = (Œ£ collateral_value √ó liquidation_threshold) / total_debt
```

---

## 5Ô∏è‚É£ PRICE ARCHITECTURE

**Primary (off-chain, fastest)**

* Binance WebSocket (spot price)
* Pyth WebSocket

**Secondary (on-chain confirmation)**

* Aave Chainlink oracle
* Used ONLY to validate legality before execution

**Prediction logic:**

* If predicted HF < 1 ‚Üí borrower enters CRITICAL
* Pre-build tx **before oracle flip**
* Beat other bots by acting on prediction

---

## 6Ô∏è‚É£ BLOCK LOOP (VERY LIGHT)

On each new block:

1. Update block metadata (number, base fee)
2. Recompute HF **ONLY for WATCH and CRITICAL borrowers**
3. Apply state transitions (CRITICAL ‚Üí LIQUIDATABLE, WATCH ‚Üí CRITICAL, etc.)
4. Emit **execution signal** if borrower is LIQUIDATABLE
5. DO NOT fetch prices
6. DO NOT scan all borrowers
7. DO NOT build transactions

**Result:** extremely fast, low-latency response.

---

## 7Ô∏è‚É£ EVENT-DRIVEN COMPONENTS (ALWAYS RUNNING)

**Aave event listeners:**

* Borrow
* Repay
* Liquidation
* Collateral config changes

Used to:

* Add/remove borrowers
* Update cached balances
* Promote borrowers between states

**Price listeners:**

* Binance WS
* Pyth WS

On price update:

* Recompute HF only for affected borrowers
* Promote SAFE ‚Üí WATCH ‚Üí CRITICAL if needed

---

## 8Ô∏è‚É£ CRITICAL STATE BEHAVIOR

When borrower enters CRITICAL:

* Simulate liquidation (`callStatic`)
* Estimate gas
* Compute expected profit
* Build tx
* Pre-sign tx
* Cache tx in memory

**No execution yet** ‚Äî execution occurs only when LIQUIDATABLE.

---

## 9Ô∏è‚É£ EXECUTION ENGINE (LIQUIDATABLE ONLY)

Execute only if:

* BorrowerState == LIQUIDATABLE
* Oracle price valid on-chain
* Expected profit ‚â• MIN_PROFIT_USD
* Gas ‚â§ MAX_GAS_USD
* ENABLE_EXECUTION = true

**Failure handling:**

* Simulation fails ‚Üí skip
* Oracle not updated ‚Üí skip
* Base fee spikes ‚Üí skip
* Tx not included ‚Üí retry once, then drop

---

## üîü CONFIGURATION (`.env`, hot-reloadable)

```env
HF_WATCH
HF_CRITICAL
HF_LIQUIDATABLE
MIN_PROFIT_USD
MAX_GAS_USD
ENABLE_EXECUTION
DRY_RUN
TARGET_DEBT_ASSETS=USDC
TARGET_COLLATERAL_ASSETS=WETH,cbETH
MAX_CONCURRENT_TX=1
```

---

## 1Ô∏è‚É£1Ô∏è‚É£ LOGGING

Log everything:

* State transitions
* HF changes
* Predicted vs oracle HF delta
* Tx lifecycle (prepared, executed, failed)
* Profit/loss

Required for tuning and auditing.

---

## 1Ô∏è‚É£2Ô∏è‚É£ FINAL DIRECTIVE

* Bot is **risk-monitoring + prediction engine + conditional executor**
* Not a scanner
* Not a brute-force mempool spammer
* Precision > frequency

> When unsure, **skip execution**.

---

‚úÖ **This version ensures:**

* Low-HF borrowers are never missed
* Event-driven promotion is clear
* Block loop is light
* Execution rules are strict
* Failures are explicitly handled

---
